{% extends "frontend/layouts/master.html" %}
{% load static %}

{% block content %}
<!-- Page Content -->
<div class="doctor-content">
    <div class="container">
        <!-- Payment -->
        <div class="row">
            <div class="col-md-12">
                <div class="back-link">
                    <a href="{% url 'home:booking' doctor.id %}"><i class="fa-solid fa-arrow-right-long"></i> رجوع</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8 col-md-12">
                <div class="paitent-header">
                    <h4 class="paitent-title">الدفع</h4>
                </div>
                <div class="booking-header">
                    <h4 class="booking-title">طرق الدفع المتاحة</h4>
                </div>
                <form id="payment-form" action="{% url 'home:payment' doctor.id %}?day={{ schedule.id }}&date={{ shift.id }}&booking_date={{ booking_date }}&type={% if is_online %}online{% else %}offline{% endif %}" method="POST">
                    {% csrf_token %}
                    <div class="payments-form">
                        <div class="payment-methods mb-4">
                            {% for method in payment_methods %}
                            <div class="payment-method-item mb-3">
                                <label class="d-flex align-items-center p-3 border rounded {% if forloop.first %}active{% endif %}">
                                    <input type="radio" name="payment_method" value="{{ method.id }}" class="me-3" {% if forloop.first %}checked{% endif %}>
                                    <div class="d-flex align-items-center flex-grow-1">
                                        {% if method.payment_option.logo %}
                                        <img src="{{ method.payment_option.logo.url }}" alt="{{ method.payment_option.method_name }}" class="payment-logo me-3" style="width: 60px; height: 40px; object-fit: contain;">
                                        {% endif %}
                                        <div>
                                            <h5 class="mb-1">{{ method.payment_option.method_name }}</h5>
                                            <div class="payment-details" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                                                <p class="mb-1"><strong>اسم الحساب:</strong> {{ method.account_name }}</p>
                                                <p class="mb-1"><strong>رقم الحساب:</strong> {{ method.account_number }}</p>
                                                <p class="mb-1"><strong>رقم الآيبان:</strong> {{ method.iban }}</p>
                                                <p class="mb-0"><strong>تعليمات الدفع:</strong> {{ method.description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="form-group mb-4">
                            <label for="transfer_number" class="form-label">رقم الحوالة</label>
                            <input type="text" id="transfer_number" name="transfer_number" class="form-control" required pattern="[0-9]{5,}" title="يجب أن يكون رقم الحوالة 5 أرقام على الأقل" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            <div class="invalid-feedback">
                                يجب أن يكون رقم الحوالة 5 أرقام على الأقل
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">تأكيد الحجز</button>
                    </div>
                </form>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="booking-header">
                    <h4 class="booking-title">ملخص الحجز</h4>
                </div>
                <div class="card booking-card">
                    <div class="card-body">
                        <div class="booking-doctor-details">
                            <div class="booking-doctor-left">
                                <div class="booking-doctor-img">
                                    <a href="{% url 'home:doctor_profile' doctor.id %}">
                                        {% if doctor.photo %}
                                            <img src="{{ doctor.photo.url }}" alt="{{ doctor.full_name }}">
                                        {% else %}
                                            <img src="{% static 'img/doctors/default-doctor.jpg' %}" alt="{{ doctor.full_name }}">
                                        {% endif %}
                                    </a>
                                </div>
                                <div class="booking-doctor-info">
                                    <h4><a href="{% url 'home:doctor_profile' doctor.id %}">{{ doctor.full_name }}</a></h4>
                                    <p>{{ doctor.specialization.name }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="booking-summary mt-4">
                            <div class="booking-item">
                                <span>التاريخ:</span>
                                <span>{{ booking_date }}</span>
                            </div>
                            <div class="booking-item">
                                <span>اليوم:</span>
                                <span>{{ schedule.get_day_display }}</span>
                            </div>
                            <div class="booking-item">
                                <span>الوقت:</span>
                                <span>{{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }}</span>
                            </div>
                            <div class="booking-item">
                                <span>نوع الكشف:</span>
                                <span>{% if is_online %}استشارة عن بعد{% else %}كشف في العيادة{% endif %}</span>
                            </div>
                            <div class="booking-item">
                                <span>المستشفى:</span>
                                <span>{{ hospital.name }}</span>
                            </div>
                            <div class="booking-total">
                                <span>المبلغ الإجمالي:</span>
                                <span>{{ amount }} ريال</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // عند تغيير طريقة الدفع
    $('input[name="payment_method"]').change(function() {
        // إخفاء جميع التفاصيل
        $('.payment-details').hide();
        // إزالة الفئة النشطة من جميع العناصر
        $('.payment-method-item label').removeClass('active');
        
        // إظهار تفاصيل طريقة الدفع المحددة
        $(this).closest('label').addClass('active')
            .find('.payment-details').show();
    });
});
</script>
{% endblock %}
