{% extends "frontend/layouts/master.html" %}
{% load static %}

{% block content %}
<!-- Page Content -->
<div class="doctor-content">
    <div class="container">
        <!-- Payment -->
        <div class="row">
            <div class="col-md-12">
                <div class="back-link">
                    <a href="{% url 'home:booking' doctor.id %}"><i class="fa-solid fa-arrow-right-long"></i> رجوع</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8 col-md-12">
                <div class="paitent-header">
                    <h4 class="paitent-title">الدفع</h4>
                </div>
                <div class="booking-header">
                    <h4 class="booking-title">طرق الدفع المتاحة</h4>
                </div>
                <div class="payment-type-selector mb-4">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="payment_type" id="payment_type_transfer" value="transfer" checked>
                        <label class="form-check-label" for="payment_type_transfer">حوالة</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="payment_type" id="payment_type_account" value="account">
                        <label class="form-check-label" for="payment_type_account">حساب</label>
                    </div>
                </div>
                <form id="payment-form" action="{% url 'payments:process' doctor.id %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="day" value="{{ selected_schedule.id }}">
                    <input type="hidden" name="date" value="{{ selected_shift.id }}">
                    <input type="hidden" name="booking_date" value="{{ booking_date }}">
                    <input type="hidden" name="hospital_id" value="{{ hospital_id }}">
                    <input type="hidden" name="type" value="{% if is_online %}online{% else %}offline{% endif %}">
                    <div class="payments-form">
                        <div class="payment-methods mb-4">
                            {% for method in payment_methods %}
                            <div class="payment-method-item mb-3">
                                <label class="d-flex align-items-center p-3 border rounded {% if forloop.first %}active{% endif %}">
                                    <input type="radio" name="payment_method" value="{{ method.id }}" class="me-3" {% if forloop.first %}checked{% endif %}>
                                    <div class="d-flex align-items-center flex-grow-1">
                                        {% if method.payment_option.logo %}
                                        <img src="{{ method.payment_option.logo.url }}" alt="{{ method.payment_option.method_name }}" class="payment-logo me-3" style="width: 60px; height: 40px; object-fit: contain;">
                                        {% endif %}
                                        <div>
                                            <h5 class="mb-1">{{ method.payment_option.method_name }}</h5>
                                            <div class="payment-details" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                                                <p class="mb-1"><strong>اسم الحساب:</strong> {{ method.account_name }}</p>
                                                <p class="mb-1"><strong>رقم الحساب:</strong> {{ method.account_number }}</p>
                                                <p class="mb-1"><strong>رقم الآيبان:</strong> {{ method.iban }}</p>
                                                <p class="mb-0"><strong>تعليمات الدفع:</strong> {{ method.description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="form-group mb-4">
                            <div id="transfer_input" class="payment-input">
                                <label for="transfer_number" class="form-label">رقم الحوالة</label>
                                <input type="text" id="transfer_number" name="transfer_number" class="form-control" required pattern="[0-9]{5,}" title="يجب أن يكون رقم الحوالة 5 أرقام على الأقل" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                                <div class="invalid-feedback">
                                    يرجى إدخال رقم الحوالة
                                </div>
                            </div>
                            <div id="account_input" class="payment-input" style="display: none;">
                                <label for="account_image" class="form-label">صورة سند الحساب (اختياري)</label>
                                <input type="file" id="account_image" name="account_image" class="form-control" accept="image/*">
                                <div class="invalid-feedback">
                                    يرجى إرفاق صورة الحساب
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">تأكيد الحجز</button>
                    </div>
                </form>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="booking-header">
                    <h4 class="booking-title">ملخص الحجز</h4>
                </div>
                <div class="card booking-card">
                    <div class="card-body">
                        <div class="booking-doctor-details">
                            <div class="booking-doctor-left">
                                <div class="booking-doctor-img">
                                    <a href="{% url 'home:doctor_profile' doctor.id %}">
                                        {% if doctor.photo %}
                                            <img src="{{ doctor.photo.url }}" alt="{{ doctor.full_name }}">
                                        {% else %}
                                            <img src="{% static 'img/doctors/default-doctor.jpg' %}" alt="{{ doctor.full_name }}">
                                        {% endif %}
                                    </a>
                                </div>
                                <div class="booking-doctor-info">
                                    <h4>{{ doctor.full_name }}</h4>
                                    <p>{{ doctor.specialty.name }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="booking-summary mt-4">
                            <h5>تفاصيل الحجز:</h5>
                            <div class="booking-summary-details">
                                <p><strong>المستشفى:</strong> {{ selected_hospital.name }}</p>
                                <p><strong>التاريخ:</strong> {{ booking_date }}</p>
                                <p><strong>الوقت:</strong> {{ selected_shift.start_time|time:"H:i" }}</p>
                                <p><strong>نوع الحجز:</strong> {% if is_online %}استشارة عن بعد{% else %}زيارة في العيادة{% endif %}</p>
                            </div>

                            <div class="price-details mt-3">
                                <h5>تفاصيل السعر:</h5>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>سعر الكشف:</span>
                                    <span class="price">{{ doctor_price.amount }} $</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // عند تغيير نوع الدفع
    $('input[name="payment_type"]').change(function() {
        const selectedType = $(this).val();

        // إخفاء جميع حقول الإدخال
        $('.payment-input').hide();

        // إظهار حقل الإدخال المحدد
        if (selectedType === 'transfer') {
            $('#transfer_input').show();
            $('#account_image').prop('required', false);
            $('#transfer_number').prop('required', true);
        } else {
            $('#account_input').show();
            $('#account_image').prop('required', false); // جعل حقل صورة السند غير مطلوب
            $('#transfer_number').prop('required', false);
        }
    });

    // عند تغيير طريقة الدفع
    $('input[name="payment_method"]').change(function() {
        // إخفاء جميع التفاصيل
        $('.payment-details').hide();
        // إزالة الفئة النشطة من جميع العناصر
        $('.payment-method-item label').removeClass('active');

        // إظهار تفاصيل طريقة الدفع المحددة
        $(this).closest('label').addClass('active')
            .find('.payment-details').show();
    });

    // تأكد من إظهار القسم الصحيح عند تحميل الصفحة
    $('input[name="payment_type"]:checked').trigger('change');
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .payment-type-selector {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .payment-type-selector .form-check-inline {
        margin-right: 2rem;
    }

    .payment-type-selector .form-check-input:checked {
        background-color: #20c0f3;
        border-color: #20c0f3;
    }

    .payment-type-selector .form-check-label {
        font-size: 1.1rem;
        color: #272b41;
    }

    .booking-summary {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .booking-summary h5 {
        color: #272b41;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .booking-summary-details p {
        margin-bottom: 8px;
        color: #757575;
    }

    .booking-summary-details strong {
        color: #272b41;
    }

    .price-details {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
    }

    .price {
        color: #20c0f3;
        font-size: 20px;
        font-weight: 600;
    }
</style>
{% endblock %}
