{% extends "frontend/layouts/master.html" %}
{% load static %}{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb-bar-two">
    <div class="container">
        <div class="row align-items-center inner-banner">
            <div class="col-md-12 col-12 text-center">
                <nav aria-label="breadcrumb" class="page-breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item" aria-current="page">{% if is_online %}Online Consultation{% else %}Booking{% endif %}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<!-- /Breadcrumb -->

<!-- Page Content -->
<div class="content content-space">
    <div class="container">
       <!-- Booking -->
       <div class="row">
           <div class="col-lg-8 col-md-12">
               <div class="booking-header">
                   <h4 class="booking-title">Book Appointment with Dr. {{ doctor.full_name }}</h4>
                   <p>{{ doctor.specialty.name }} • {{ doctor.hospitals.first.name }}</p>
               </div>
               <div class="booking-date choose-date-book">
                   <p>Choose a Date</p>
                   <div class="booking-range">
                       <div class="bookingrange btn">
                           <img src="{% static 'img/icons/today-icon.svg' %}" alt="calendar-image">
                           <span></span>
                           <input id="datepicker" class="form-control" name="booking_date" placeholder="Select a date">
                           <i class="fas fa-chevron-down"></i>
                       </div>
                   </div>
               </div>
               <div class="card booking-card">
                   <div class="card-body time-slot-card-body">
                       <div class="booking-date-slider">
                           <ul class="date-slider slick">
                               {% for schedule in dayes %}
                               <li 
                                   class="{% if schedule.id == selected_day %}active{% endif %}" 
                                   data-schedule="{{ schedule.id }}" 
                                   data-start="{{ schedule.shifts.start_time|time:'H:i' }}" 
                                   data-end="{{ schedule.shifts.end_time|time:'H:i' }}">
                                   <h4>{{ schedule.get_day_display }}</h4>
                                   <p>{{ schedule.date|date:"M d" }}</p>
                               </li>
                               {% endfor %}
                           </ul>
                       </div>
                       <!-- Time Details Display -->
                       <div id="time-details" class="time-details mt-3">
                           {% include "frontend/home/pages/time_slots.html" %}
                       </div>
                   </div>
               </div>

               <!-- Form for next step -->
               <form id="booking-form" action="{% url 'home:payment' doctor.id %}" method="GET">
                   <input type="hidden" name="day" id="day_id" value="{{ selected_day }}">
                   <input type="hidden" name="date" id="date_id">
                   <input type="hidden" name="booking_date" id="booking_date_input">
                   <div class="booking-btn">
                       <button type="submit" id="next-btn" class="btn btn-primary prime-btn justify-content-center align-items-center" disabled>
                           Next <i class="feather-arrow-right-circle"></i>
                       </button>
                   </div>
               </form>
           </div>

           <div class="col-lg-4 col-md-12">
               <div class="booking-header">
                   <h4 class="booking-title">Booking Summary</h4>
               </div>
               <div class="card booking-card">
                   <div class="card-body booking-card-body">
                       <div class="booking-doctor-details">
                           <div class="booking-doctor-left">
                               <div class="booking-doctor-img">
                                   {% if doctor.image %}
                                   <img src="{{ doctor.image.url }}" class="img-fluid" alt="{{ doctor.full_name }}">
                                   {% else %}
                                   <img src="{% static 'img/doctors/doctor-thumb-02.jpg' %}" class="img-fluid" alt="Doctor Image">
                                   {% endif %}
                               </div>
                               <div class="booking-doctor-info">
                                   <h4><a href="{% url 'doctors:doctor_detail' doctor.id %}">Dr. {{ doctor.full_name }}</a></h4>
                                   <p>{{ doctor.specialty.name }}</p>
                               </div>
                           </div>
                       </div>
                       <div class="booking-availability">
                           <h5>Available Days:</h5>
                           <ul class="list-group">
                               {% for schedule in dayes %}
                               <li class="list-group-item">
                                   <i class="fas fa-calendar-alt"></i> {{ schedule.get_day_display }}
                               </li>
                               {% empty %}
                               <li class="list-group-item">No schedules available.</li>
                               {% endfor %}
                           </ul>
                       </div>
                   </div>
               </div>
           </div>
       </div>
    </div>
</div>
<!-- /Page Content -->
{% endblock %}

{% block extra_js %}
<!-- Include jQuery and jQuery UI -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<script>
$(document).ready(function () {
    // تهيئة التقويم
    $("#datepicker").datepicker({
        dateFormat: "yy-mm-dd",
        minDate: 0,
        onSelect: function (dateText) {
            $("#booking_date_input").val(dateText);
            checkFormCompletion();
        }
    });

    // عند النقر على يوم
    $('.date-slider li').on('click', function () {
        const selectedScheduleId = $(this).data('schedule');
        const doctorId = {{ doctor.id }};
        
        // تحديث الواجهة
        $('.date-slider li').removeClass('active');
        $(this).addClass('active');
        $('#day_id').val(selectedScheduleId);
        
        // إظهار رسالة تحميل
        $('#time-details').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري تحميل المواعيد...</div>');
        
        // جلب المواعيد المتاحة
        $.ajax({
            url: `/get-time-slots/${selectedScheduleId}/${doctorId}/`,
            method: 'GET',
            success: function(response) {
                $('#time-details').html(response.html);
                // إعادة تعيين اختيار الوقت
                $('#date_id').val('');
                checkFormCompletion();
            },
            error: function(xhr, status, error) {
                $('#time-details').html('<div class="alert alert-danger">عذراً، حدث خطأ أثناء تحميل المواعيد. يرجى المحاولة مرة أخرى.</div>');
                console.error('Error fetching time slots:', error);
            }
        });
    });

    // عند النقر على وقت
    $(document).on('click', '.timing.available', function() {
        const scheduleId = $(this).data('schedule');
        $('.timing').removeClass('selected');
        $(this).addClass('selected');
        $('#date_id').val(scheduleId);
        checkFormCompletion();
    });
    
    // التحقق من اكتمال النموذج
    function checkFormCompletion() {
        const dayId = $('#day_id').val();
        const dateId = $('#date_id').val();
        const bookingDate = $('#booking_date_input').val();
        
        if (dayId && dateId && bookingDate) {
            $('#next-btn').prop('disabled', false);
        } else {
            $('#next-btn').prop('disabled', true);
        }
    }
    
    // التحقق من النموذج قبل الإرسال
    $('#booking-form').on('submit', function(e) {
        const dayId = $('#day_id').val();
        const dateId = $('#date_id').val();
        const bookingDate = $('#booking_date_input').val();

        if (!dayId || !dateId || !bookingDate) {
            e.preventDefault();
            let missingFields = [];
            if (!dayId) missingFields.push('يوم الموعد');
            if (!dateId) missingFields.push('وقت الموعد');
            if (!bookingDate) missingFields.push('تاريخ الحجز');
            
            alert('الرجاء اختيار:\n- ' + missingFields.join('\n- '));
            return false;
        }
        return true;
    });
    
    // تحديث حالة الزر عند تحميل الصفحة
    checkFormCompletion();
});
</script>

<style>
.timing.selected {
    background-color: #20c0f3 !important;
    border-color: #20c0f3 !important;
    color: #fff !important;
}

.timing.available {
    cursor: pointer;
}

.timing:not(.available) {
    opacity: 0.5;
    cursor: not-allowed;
}

.date-slider li {
    cursor: pointer;
}

.date-slider li.active {
    background-color: #20c0f3;
    color: #fff;
}
</style>
{% endblock %}
