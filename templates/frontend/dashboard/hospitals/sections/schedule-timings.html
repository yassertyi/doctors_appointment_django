<div class="col-md-7 col-lg-8 col-xl-9 schedule_timings section">
						 
	<div class="row">
		<div class="col-sm-12">
			<div class="card">
				<div class="card-body">
					<h4 class="card-title">جدولة المواعيد</h4>
					<div class="profile-box">
						<div class="row">
							<div class="row mb-4">
								<div class="col-md-6">
									<div class="form-group">
										<label>اختر الطبيب</label>
										<select class="form-select" id="doctor_select">
											<option value="">-- اختر الطبيب --</option>
											{% for doctor in doctors %}
											<option value="{{ doctor.id }}">{{ doctor.full_name }} - {{ doctor.specialty.name }}</option>
											{% endfor %}
										</select>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>حالة الجدول</label>
										<div class="status-toggle">
											<input type="checkbox" id="status_toggle" class="check">
											<label for="status_toggle" class="checktoggle">متاح/غير متاح</label>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<div class="card schedule-widget mb-0">
									
									<!-- Schedule Header -->
									<div class="schedule-header">
										<div class="schedule-nav">
											<ul class="nav nav-tabs nav-justified">
												{% for value, name in days %}
												<li class="nav-item">
													<a class="nav-link {% if forloop.counter == 2 %}active{% endif %}" data-bs-toggle="tab" href="#slot_{{ value|lower }}">{{ name }}</a>
												</li>
												{% endfor %}
											</ul>
										</div>
									</div>
									<!-- /Schedule Header -->
									
									<!-- Schedule Content -->
									<div class="tab-content schedule-cont">
										
										{% for value, name in days %}
										<div id="slot_{{ value|lower }}" class="tab-pane fade {% if forloop.counter == 2 %}show active{% endif %}">
											<div class="row">
												<div class="col-md-8">
													<h4 class="card-title">{{ name }}</h4>
													<!-- Time Slots -->
													<div class="doc-times">
														<p class="text-muted mb-0">لا توجد مواعيد</p>
													</div>
												</div>
												<div class="col-md-4">
													<div class="card">
														<div class="card-body">
															<h4 class="card-title">إضافة موعد</h4>
															<form class="add-time-slot-form" data-day="{{ value }}">
																{% csrf_token %}
																<input type="hidden" name="day" value="{{ value }}">
																
																<div class="mb-3">
																	<label class="form-label">وقت البداية</label>
																	<div class="row g-2">
																		<div class="col">
																			<select name="start_hour" class="form-select" required>
																				{% for h in ""|rjust:"24" %}
																				<option value="{{ forloop.counter0|stringformat:'02d' }}">{{ forloop.counter0|stringformat:'02d' }}</option>
																				{% endfor %}
																			</select>
																		</div>
																		<div class="col">
																			<select name="start_minute" class="form-select" required>
																				<option value="00">00</option>
																				<option value="15">15</option>
																				<option value="30">30</option>
																				<option value="45">45</option>
																			</select>
																		</div>
																	</div>
																</div>

																<div class="mb-3">
																	<label class="form-label">وقت النهاية</label>
																	<div class="row g-2">
																		<div class="col">
																			<select name="end_hour" class="form-select" required>
																				{% for h in ""|rjust:"24" %}
																				<option value="{{ forloop.counter0|stringformat:'02d' }}">{{ forloop.counter0|stringformat:'02d' }}</option>
																				{% endfor %}
																			</select>
																		</div>
																		<div class="col">
																			<select name="end_minute" class="form-select" required>
																				<option value="00">00</option>
																				<option value="15">15</option>
																				<option value="30">30</option>
																				<option value="45">45</option>
																			</select>
																		</div>
																	</div>
																</div>

																<div class="mb-3">
																	<label class="form-label">عدد المواعيد المتاحة</label>
																	<input type="number" name="max_appointments" class="form-control" value="1" min="1" required>
																</div>

																<div class="text-end">
																	<button type="submit" class="btn btn-primary">
																		<i class="fas fa-plus-circle me-1"></i>
																		إضافة
																	</button>
																</div>
															</form>
														</div>
													</div>
												</div>
											</div>
										</div>
										{% endfor %}
										
									</div>
									<!-- /Schedule Content -->
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
		
</div>

<!-- Add Time Slot Modal -->
<div class="modal fade" id="add_time_slot">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">إضافة موعد جديد</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form id="add_time_slot_form">
					{% csrf_token %}
					<input type="hidden" name="doctor_id" id="modal_doctor_id">
					<div class="form-group">
						<label>اليوم</label>
						<select name="day" class="form-select" required>
							{% for day_value, day_name in days %}
							<option value="{{ day_value }}">{{ day_name }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="form-group">
						<label>وقت البداية</label>
						<input type="time" name="start_time" class="form-control" required>
					</div>
					<div class="form-group">
						<label>وقت النهاية</label>
						<input type="time" name="end_time" class="form-control" required>
					</div>
					<div class="form-group">
						<label>مدة الموعد (بالدقائق)</label>
						<input type="number" name="slot_duration" class="form-control" min="15" step="15" value="30">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
				<button type="submit" form="add_time_slot_form" class="btn btn-primary">حفظ</button>
			</div>
		</div>
	</div>
</div>

<!-- Copy Timings Modal -->
<div class="modal fade" id="copy_timings">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">نسخ المواعيد</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form>
					<div class="form-group">
						<label>نسخ من</label>
						<select class="form-select">
							<option>الإثنين</option>
							<option>الثلاثاء</option>
							<option>الأربعاء</option>
							<option>الخميس</option>
							<option>الجمعة</option>
							<option>السبت</option>
							<option>الأحد</option>
						</select>
					</div>
					<div class="form-group">
						<label>نسخ إلى</label>
						<div class="checkbox-group">
							<div class="form-check">
								<input type="checkbox" class="form-check-input" id="copy_sunday">
								<label class="form-check-label" for="copy_sunday">الأحد</label>
							</div>
							<div class="form-check">
								<input type="checkbox" class="form-check-input" id="copy_monday">
								<label class="form-check-label" for="copy_monday">الإثنين</label>
							</div>
							<!-- Add other days... -->
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
				<button type="button" class="btn btn-primary">نسخ المواعيد</button>
			</div>
		</div>
	</div>
</div>

<style>
    #alert-messages {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    }

    .alert {
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 4px;
        opacity: 0.9;
        transition: opacity 0.3s ease-in-out;
    }

    .alert:hover {
        opacity: 1;
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .alert .btn-close {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
    }
</style>

<div id="messages-container"></div>

<style>
#messages-container {
    margin-bottom: 20px;
}

.alert {
    position: relative;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.25rem;
}

.alert-success {
    color: #0f5132;
    background-color: #d1e7dd;
    border-color: #badbcc;
}

.alert-danger {
    color: #842029;
    background-color: #f8d7da;
    border-color: #f5c2c7;
}

.alert-dismissible {
    padding-right: 3rem;
}

.alert-dismissible .btn-close {
    position: absolute;
    top: 0;
    right: 0;
    padding: 1.25rem 1rem;
}
</style>

{% block extra_js %}
<script>
// دالة لعرض الرسائل
function showMessage(message, type = 'danger') {
    const messagesContainer = document.getElementById('messages-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    messagesContainer.appendChild(alertDiv);
    
    // إخفاء الرسالة تلقائياً بعد 5 ثواني
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

$(document).ready(function() {
    var doctorSchedules = {{ doctor_schedules|safe|default:'{}' }};
    console.log("Initial doctor schedules:", doctorSchedules);
    
    // تحميل جدول الطبيب عند اختياره
    $('#doctor_select').change(function() {
        var doctorId = $(this).val();
        console.log("Selected doctor:", doctorId);
        
        if (doctorId) {
            var schedules = doctorSchedules[doctorId] || {};
            updateScheduleDisplay(schedules);
            $('.add-time-slot-form button[type="submit"]').prop('disabled', false);
        } else {
            $('.doc-times').empty().html('<p class="text-muted mb-0">لا توجد مواعيد</p>');
            $('.add-time-slot-form button[type="submit"]').prop('disabled', true);
        }
    });

    // معالجة إضافة موعد جديد
    $('.add-time-slot-form').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const doctorId = $('#doctor_select').val();
        
        if (!doctorId) {
            showMessage('الرجاء اختيار الطبيب أولاً');
            return;
        }

        // تجميع البيانات
        const formData = new FormData();
        formData.append('doctor_id', doctorId);
        formData.append('day', form.data('day'));
        formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
        
        // تجميع وقت البداية والنهاية
        const startHour = form.find('[name="start_hour"]').val();
        const startMinute = form.find('[name="start_minute"]').val();
        const endHour = form.find('[name="end_hour"]').val();
        const endMinute = form.find('[name="end_minute"]').val();
        
        formData.append('start_time', `${startHour}:${startMinute}`);
        formData.append('end_time', `${endHour}:${endMinute}`);
        formData.append('max_appointments', form.find('[name="max_appointments"]').val());

        // تعطيل زر الإرسال
        const submitButton = form.find('button[type="submit"]');
        submitButton.prop('disabled', true);
        
        // طباعة البيانات للتأكد منها
        console.log('Sending data:', {
            doctor_id: doctorId,
            day: form.data('day'),
            start_time: `${startHour}:${startMinute}`,
            end_time: `${endHour}:${endMinute}`,
            max_appointments: form.find('[name="max_appointments"]').val()
        });

        $.ajax({
            url: '{% url "hospitals:schedule_timings" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log('Response:', response);
                if (response.status === 'success') {
                    showMessage(response.message, 'success');
                    // تحديث عرض المواعيد
                    if (response.shift) {
                        const schedules = {};
                        schedules[doctorId] = {};
                        schedules[doctorId][form.data('day')] = [response.shift];
                        updateScheduleDisplay(schedules);
                    }
                    // إعادة تعيين النموذج
                    form[0].reset();
                } else {
                    showMessage(response.message || 'حدث خطأ أثناء حفظ الموعد');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', xhr.responseText);
                let errorMessage = 'حدث خطأ أثناء معالجة الطلب';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                showMessage(errorMessage);
            },
            complete: function() {
                // إعادة تفعيل زر الإرسال
                submitButton.prop('disabled', false);
            }
        });
    });

    // معالجة حذف موعد
    $(document).on('click', '.delete-time-slot', function(e) {
        e.preventDefault();
        const shiftId = $(this).data('shift-id');
        
        if (confirm('هل أنت متأكد من حذف هذا الموعد؟')) {
            $.ajax({
                url: "{% url 'hospitals:delete_shift' '0' %}".replace('0', shiftId),
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.status === 'success') {
                        showMessage(response.message, 'success');
                        // تحديث عرض المواعيد
                        const doctorId = $('#doctor_select').val();
                        if (doctorSchedules[doctorId]) {
                            Object.keys(doctorSchedules[doctorId]).forEach(function(day) {
                                doctorSchedules[doctorId][day] = doctorSchedules[doctorId][day].filter(
                                    shift => shift.id !== shiftId
                                );
                            });
                            updateScheduleDisplay(doctorSchedules[doctorId]);
                        }
                    } else {
                        showMessage(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    let errorMessage = 'حدث خطأ أثناء حذف الموعد';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing response:', e);
                    }
                    showMessage(errorMessage);
                }
            });
        }
    });

    // تحديث عرض الجدول
    function updateScheduleDisplay(schedules) {
        console.log("Updating display with schedules:", schedules);
        $('.doc-times').empty().html('<p class="text-muted mb-0">لا توجد مواعيد</p>');
        
        Object.keys(schedules).forEach(function(day) {
            var shifts = schedules[day];
            var dayId = day.toString().padStart(1, '0');
            var docTimes = $(`#slot_${dayId}`).find('.doc-times');
            
            if (shifts && shifts.length > 0) {
                docTimes.empty();
                shifts.forEach(function(shift) {
                    var slotHtml = `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">${shift.start_time} - ${shift.end_time}</h5>
                                        <div class="text-muted small">
                                            عدد المواعيد: ${shift.available_slots}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-1">
                                            <span class="badge bg-success">${shift.available_slots} متاح</span>
                                            <span class="badge bg-warning">${shift.booked_slots} محجوز</span>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-danger delete-time-slot" data-shift-id="${shift.id}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    docTimes.append(slotHtml);
                });
            }
        });
    }
});
</script>
{% endblock %}