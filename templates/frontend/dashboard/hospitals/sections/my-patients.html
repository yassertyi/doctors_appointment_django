{% load static %}

<div class="col-md-7 col-lg-8 col-xl-9 my_patient section">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap justify-content-between align-items-center">
                <h2 class="mb-3 mb-md-0">المرضى</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#filterSection">
                        <i class="fas fa-filter me-2"></i>فلترة
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-sort me-2"></i>ترتيب حسب
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-sort="full_name">الاسم</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="id">رقم المريض</a></li>
                            <li><a class="dropdown-item" href="#" data-sort="age">العمر</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- البحث والفلترة -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- شريط البحث -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="patientSearch" class="form-control border-start-0"
                                    placeholder="ابحث عن المرضى بالاسم أو الرقم التعريفي...">
                            </div>
                        </div>
                    </div>

                    <!-- فلاتر قابلة للطي -->
                    <div class="collapse" id="filterSection">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">الجنس</label>
                                <select class="form-select" id="genderFilter">
                                    <option value="">الكل</option>
                                    <option value="0">ذكر</option>
                                    <option value="1">أنثى</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">الفئة العمرية</label>
                                <select class="form-select" id="ageFilter">
                                    <option value="">الكل</option>
                                    <option value="0-18">0-18</option>
                                    <option value="19-30">19-30</option>
                                    <option value="31-50">31-50</option>
                                    <option value="51+">51+</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">الموقع</label>
                                <input type="text" class="form-control" id="locationFilter"
                                    placeholder="أدخل الموقع">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول المرضى -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="patientTable">
                    <thead class="table-light">
                        <tr>
                            <th>رقم المريض</th>
                            <th>الصورة</th>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>الجنس</th>
                            <th>عدد الحجوزات</th>
                            <th>آخر حجز</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr class="patient-row" data-name="{{ patient.user.get_full_name }}" data-id="{{ patient.id }}"
                            data-gender="{{ patient.gender }}" data-age="{{ patient.age|default:0 }}">
                            <td>{{ patient.id }}</td>
                            <td>
                                <img src="{{ patient.user.profile_picture.url|default:'https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=500&h=500&fit=crop' }}"
                                    class="patient-avatar rounded-circle" alt="{{ patient.user.get_full_name }}">
                            </td>
                            <td>{{ patient.user.get_full_name }}</td>
                            <td>{{ patient.user.email }}</td>
                            <td>
                                <span class="badge {% if patient.gender == 'Male' %}bg-info{% else %}bg-primary{% endif %}">
                                    {% if patient.gender == 'Male' %}
                                    ذكر
                                    {% else %}
                                    أنثى
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex flex-column align-items-center">
                                    <strong class="small text-muted mb-1">إجمالي الحجوزات</strong>
                                    <span class="badge rounded-pill bg-success fs-6 px-3">{{ patient.booking_count }}</span>
                                </div>
                            </td>
                            <td>
                                {% if patient.last_booking %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    <span>{{ patient.last_booking.booking_date }}</span>
                                </div>
                                {% else %}
                                <span class="text-muted">لا يوجد حجوزات سابقة</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="#" class="btn btn-sm btn-outline-primary" title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="#" class="btn btn-sm btn-outline-success" title="حجز جديد">
                                        <i class="fas fa-calendar-plus"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="text-center py-5 d-none">
        <div class="text-muted">
            <i class="fas fa-search fa-3x mb-3"></i>
            <h4>No patients found</h4>
            <p>Try adjusting your search or filters</p>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .table th {
        font-weight: 600;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .patient-avatar {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border: 2px solid #eee;
    }
    
    /* Стили для состояния строки фильтрации */
    .patient-row.filtered {
        display: none;
    }
    
    /* Добавляем направление текста справа налево для таблицы */
    .table {
        direction: rtl;
        text-align: right;
    }
    
    /* Выравнивание некоторых столбцов по центру */
    .table th:nth-child(2),
    .table td:nth-child(2),
    .table th:nth-child(5),
    .table td:nth-child(5),
    .table th:nth-child(6),
    .table td:nth-child(6),
    .table th:nth-child(8),
    .table td:nth-child(8) {
        text-align: center;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const patientSearch = document.getElementById('patientSearch');
        const genderFilter = document.getElementById('genderFilter');
        const ageFilter = document.getElementById('ageFilter');
        const locationFilter = document.getElementById('locationFilter');
        const patientRows = document.querySelectorAll('.patient-row');
        const noResults = document.getElementById('noResults');
        const patientTable = document.getElementById('patientTable');

        function filterPatients() {
            const searchTerm = patientSearch.value.toLowerCase();
            const gender = genderFilter.value;
            const ageRange = ageFilter.value;
            const location = locationFilter.value.toLowerCase();

            let visibleCount = 0;

            patientRows.forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const id = row.dataset.id.toLowerCase();
                const rowGender = row.dataset.gender;
                const rowAge = parseInt(row.dataset.age);
                // Podemos obtener la ubicación de las celdas si es necesario
                // const rowLocation = row.querySelector('td:nth-child(5)').textContent.toLowerCase();

                let isVisible = true;

                // Filtro de búsqueda (nombre, ID o correo electrónico)
                if (searchTerm && !name.includes(searchTerm) && !id.includes(searchTerm) && 
                    !row.querySelector('td:nth-child(4)').textContent.toLowerCase().includes(searchTerm)) {
                    isVisible = false;
                }

                // Filtro de género
                if (gender && rowGender !== gender) {
                    isVisible = false;
                }

                // Filtro de rango de edad
                if (ageRange) {
                    const [min, max] = ageRange.split('-').map(num => num.replace('+', ''));
                    if ((min && rowAge < parseInt(min)) || (max && rowAge > parseInt(max))) {
                        isVisible = false;
                    }
                }

                // Location filter - commented out as we may not have location data now
                // if (location && !rowLocation.includes(location)) {
                //     isVisible = false;
                // }

                // Aplicar filtro
                if (isVisible) {
                    row.classList.remove('filtered');
                    visibleCount++;
                } else {
                    row.classList.add('filtered');
                }
            });

            // Show no results message if no visible patients
            if (visibleCount === 0) {
                noResults.classList.remove('d-none');
            } else {
                noResults.classList.add('d-none');
            }
        }

        patientSearch.addEventListener('input', filterPatients);
        genderFilter.addEventListener('change', filterPatients);
        ageFilter.addEventListener('change', filterPatients);
        locationFilter.addEventListener('input', filterPatients);
    });
</script>
{% endblock %}