
{% csrf_token %}
<div class="col-md-7 col-lg-8 col-xl-9 appointments section d-none">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="card-title">الحجوزات</h4>
                        </div>
                        <div class="col-auto">
                            <div class="status-filter">
                                <select class="form-select" id="status-filter">
                                    <option value="all">جميع الحجوزات</option>
                                    <option value="pending">قيد الانتظار</option>
                                    <option value="confirmed">مؤكدة</option>
                                    <option value="completed">مكتملة</option>
                                    <option value="cancelled">ملغية</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <input type="text" id="search-input" class="form-control me-2" placeholder="ابحث عن حجز (اسم المريض، الطبيب، رقم الحوالة)..." onkeyup="filterAppointments()">
                            
                            <button onclick="printTable()" class="btn btn-primary" data-bs-toggle="tooltip" title="طباعة الحجوزات">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-center mb-0" id="appointments-table">
                            <thead>
                                <tr>
                                    <th>المريض</th>
                                    <th>الطبيب</th>
                                    <th>التخصص</th>
                                    <th>موعد الحجز</th>
                                    <th>المبلغ</th>
                                    <th>رقم الحوالة</th>
                                    <th>حالة الحجز</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in bookings %}
                                <tr>
                                    <td>
                                        <h2 class="table-avatar">
                                            {% if booking.patient.profile_picture %}
                                                <img src="{{ booking.patient.profile_picture.url }}" alt="صورة المريض" class="avatar avatar-sm">
                                            {% endif %}
                                            <a href="javascript:void(0);" class="ms-2">
                                                {{ booking.patient.full_name }}
                                                <small class="d-block text-muted">
                                                    {{ booking.patient.mobile_number }}
                                                </small>
                                            </a>
                                        </h2>
                                    </td>
                                    <td>
                                        <h2 class="table-avatar">
                                            {% if booking.doctor.profile_image %}
                                                <img src="{{ booking.doctor.profile_image.url }}" alt="صورة الطبيب" class="avatar avatar-sm">
                                            {% endif %}
                                            <a href="javascript:void(0);" class="ms-2">
                                                د. {{ booking.doctor.full_name }}
                                            </a>
                                        </h2>
                                    </td>
                                    <td>{{ booking.doctor.specialty.name }}</td>
                                    <td>
                                        <span class="d-block">{{ booking.booking_date }}</span>
                                        <small class="text-muted">{{ booking.appointment_time.start_time|time:"g:i A" }}</small>
                                    </td>
                                    <td>
                                        <span class="text-primary fw-bold">{{ booking.amount }} ريال</span>
                                    </td>
                                    <td>
                                        {% if booking.transfer_number %}
                                            <span class="badge bg-info">{{ booking.transfer_number }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">لم يتم التحويل</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if booking.status == 'pending' %}
                                            <span class="badge rounded-pill bg-warning">قيد الانتظار</span>
                                        {% elif booking.status == 'confirmed' %}
                                            <span class="badge rounded-pill bg-success">مؤكد</span>
                                        {% elif booking.status == 'cancelled' %}
                                            <span class="badge rounded-pill bg-danger">ملغي</span>
                                        {% elif booking.status == 'completed' %}
                                            <span class="badge rounded-pill bg-info">مكتمل</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'bookings:appointment_details' booking.id %}" 
                                               class="btn btn-sm bg-info-light" 
                                               data-bs-toggle="tooltip" 
                                               title="عرض التفاصيل">
                                                <i class="far fa-eye"></i>
                                            </a>
                                            {% if booking.status == 'pending' %}
                                                <button type="button" 
                                                        class="btn btn-sm bg-success-light accept-booking" 
                                                        data-booking-id="{{ booking.id }}"
                                                        data-bs-toggle="tooltip"
                                                        title="قبول الحجز">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            {% endif %}
                                            {% if booking.status == 'confirmed' %}
                                                <button type="button" 
                                                        class="btn btn-sm bg-info-light confirmed-booking" 
                                                        data-booking-id-confirmed="{{ booking.id }}"
                                                        data-bs-toggle="tooltip"
                                                        title="تأكيد اكتمال الحجز">
                                                    <i class="fas fa-check-double"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">لا توجد حجوزات حالياً</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
             <div class="pagination mb-3">
                <button id="prev-page" class="btn btn-secondary" onclick="changePage(-1)">الصفحة السابقة</button>
                <button id="next-page" class="btn btn-secondary" onclick="changePage(1)">الصفحة التالية</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    let currentPage = 1;
    const rowsPerPage = 5;
    
    // دالة للبحث في الحجوزات
    function filterAppointments() {
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        const table = document.getElementById('appointments-table');
        const rows = Array.from(table.getElementsByTagName('tr')).slice(1);

        // تطبيق الفلتر على كل صف
        rows.forEach(row => {
            let display = true;
            const searchableColumns = [
                row.getElementsByTagName('td')[0], // المريض
                row.getElementsByTagName('td')[1], // الطبيب
                row.getElementsByTagName('td')[2], // التخصص
                row.getElementsByTagName('td')[5]  // رقم الحوالة
            ];

            // البحث النصي
            let textMatch = searchInput === '' || searchableColumns.some(column => 
                column && column.textContent.toLowerCase().includes(searchInput)
            );

            // فلترة حسب الحالة
            const statusCell = row.getElementsByTagName('td')[6];
            let statusMatch = statusFilter === 'all';
            
            if (statusCell) {
                const statusText = statusCell.textContent.trim().toLowerCase();
                if (statusFilter === 'pending' && statusText.includes('قيد الانتظار')) {
                    statusMatch = true;
                } else if (statusFilter === 'confirmed' && statusText.includes('مؤكد')) {
                    statusMatch = true;
                } else if (statusFilter === 'completed' && statusText.includes('مكتمل')) {
                    statusMatch = true;
                } else if (statusFilter === 'cancelled' && statusText.includes('ملغي')) {
                    statusMatch = true;
                }
            }

            // تحديد ما إذا كان سيتم عرض الصف
            row.dataset.visible = textMatch && statusMatch ? 'true' : 'false';
        });

        // إعادة تعيين رقم الصفحة الحالية وعرض الصفوف
        currentPage = 1;
        displayRows();
    }

    // دالة لعرض الصفوف للصفحة الحالية
    function displayRows() {
        const table = document.getElementById('appointments-table');
        const rows = Array.from(table.getElementsByTagName('tr')).slice(1);
        const visibleRows = rows.filter(row => row.dataset.visible !== 'false');
        
        // حساب نطاق الصفوف للصفحة الحالية
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        
        // إخفاء جميع الصفوف أولاً
        rows.forEach(row => row.style.display = 'none');
        
        // عرض الصفوف المطلوبة فقط
        visibleRows.slice(start, end).forEach(row => row.style.display = '');
        
        // تحديث حالة أزرار التنقل
        updatePaginationButtons(visibleRows.length);
    }

    // دالة لتحديث حالة أزرار التنقل
    function updatePaginationButtons(totalVisibleRows) {
        const totalPages = Math.ceil(totalVisibleRows / rowsPerPage);
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage >= totalPages;
        
        // إظهار أو إخفاء أزرار التنقل بناءً على عدد الصفوف
        const paginationDiv = document.querySelector('.pagination');
        paginationDiv.style.display = totalVisibleRows > rowsPerPage ? '' : 'none';
    }

    // دالة تغيير الصفحة
    function changePage(direction) {
        const table = document.getElementById('appointments-table');
        const visibleRows = Array.from(table.getElementsByTagName('tr'))
            .slice(1)
            .filter(row => row.dataset.visible !== 'false');
            
        const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            displayRows();
        }
    }

    // دالة الطباعة
    function printTable() {
        // حفظ حالة العرض الحالية لجميع الصفوف
        const table = document.getElementById('appointments-table');
        const rows = Array.from(table.getElementsByTagName('tr')).slice(1); // تجاهل صف العناوين
        const displayStates = rows.map(row => row.style.display);

        // إظهار جميع الصفوف التي تتطابق مع الفلتر الحالي
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        rows.forEach(row => {
            const cells = Array.from(row.getElementsByTagName('td'));
            if (cells.length > 0) {
                // البحث النصي
                const searchableText = [
                    cells[1].textContent, // اسم المريض
                    cells[2].textContent, // اسم الطبيب
                    cells[5].textContent  // رقم الحوالة
                ].join(' ').toLowerCase();

                const textMatch = searchInput === '' || searchableText.includes(searchInput);

                // فلتر الحالة
                const statusCell = cells[6]; // خلية الحالة
                let statusMatch = statusFilter === 'all';
                
                if (statusCell) {
                    const statusText = statusCell.textContent.trim().toLowerCase();
                    if (statusFilter === 'pending' && statusText.includes('قيد الانتظار')) {
                        statusMatch = true;
                    } else if (statusFilter === 'confirmed' && statusText.includes('مؤكد')) {
                        statusMatch = true;
                    } else if (statusFilter === 'completed' && statusText.includes('مكتمل')) {
                        statusMatch = true;
                    } else if (statusFilter === 'cancelled' && statusText.includes('ملغي')) {
                        statusMatch = true;
                    }
                }

                // تحديث حالة العرض للطباعة
                if (textMatch && statusMatch) {
                    row.style.display = '';
                    row.classList.add('table-print');
                } else {
                    row.style.display = 'none';
                    row.classList.remove('table-print');
                }
            }
        });

        // إنشاء وإضافة ترويسة الطباعة
        const printHeader = document.createElement('div');
        printHeader.className = 'print-header';
        const visibleRowsCount = rows.filter(row => row.style.display !== 'none').length;
        
        printHeader.innerHTML = `
            <h2>قائمة الحجوزات</h2>
            <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>
            <p>عدد الحجوزات: ${visibleRowsCount}</p>
            ${statusFilter !== 'all' ? `<p>الفلتر: ${document.getElementById('status-filter').options[document.getElementById('status-filter').selectedIndex].text}</p>` : ''}
            ${searchInput ? `<p>البحث: ${searchInput}</p>` : ''}
        `;

        // إضافة الترويسة قبل الجدول
        table.parentNode.insertBefore(printHeader, table);

        // طباعة الصفحة
        window.print();

        // استعادة حالة العرض الأصلية وإزالة الترويسة
        setTimeout(() => {
            rows.forEach((row, index) => {
                row.style.display = displayStates[index];
                row.classList.remove('table-print');
            });
            printHeader.remove();
        }, 100);
    }

    // دالة لمعالجة قبول الحجز
    document.querySelectorAll(".accept-booking").forEach(function(button) {
        button.addEventListener("click", function() {
            const bookingId = this.getAttribute("data-booking-id");
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'hospitals:accept_appointment' booking_id=0 %}".replace('0', bookingId), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'حدث خطأ أثناء قبول الحجز');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('تم قبول الحجز وتأكيد الدفع بنجاح');
                    location.reload();
                } else {
                    throw new Error(data.message || 'حدث خطأ غير معروف');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert(error.message || 'حدث خطأ أثناء قبول الحجز');
            });
        });
    });


    // دالة لمعالجة تاكيد الحجز
    document.querySelectorAll(".confirmed-booking").forEach(function(button) {
        button.addEventListener("click", function() {
            const bookingId = this.getAttribute("data-booking-id-confirmed");
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'hospitals:completed_appointment' booking_id=0 %}".replace('0', bookingId), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'حدث خطأ أثناء قبول الحجز');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('تم قبول الحجز وتأكيد الدفع بنجاح');
                    location.reload();
                } else {
                    throw new Error(data.message || 'حدث خطأ غير معروف');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert(error.message || 'حدث خطأ أثناء قبول الحجز');
            });
        });
    });

    // إضافة مستمعي الأحداث
    document.addEventListener('DOMContentLoaded', function() {
        // تطبيق الفلترة الأولية وعرض الصفوف
        filterAppointments();
        
        // إضافة مستمعي الأحداث للفلترة
        document.getElementById('status-filter').addEventListener('change', filterAppointments);
        document.getElementById('search-input').addEventListener('input', filterAppointments);
        
        // تفعيل tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
<style>
/* تنسيقات الطباعة */
@media print {
    /* إخفاء العناصر غير المطلوبة عند الطباعة */
    .no-print, 
    .no-print *,
    #sidebar,
    .navbar,
    .footer,
    .breadcrumb,
    .page-header,
    .card-header,
    .modal,
    .btn,
    select,
    input,
    #search-input,
    #status-filter,
    .nav,
    .nav-tabs,
    .tab-content > .tab-pane {
        display: none !important;
    }

    /* إظهار محتوى التاب بغض النظر عن حالته */
    .tab-content > .tab-pane {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* تنسيق الصفحة للطباعة */
    body {
        margin: 0;
        padding: 0;
        background: #fff !important;
    }

    .main-wrapper {
        margin: 0 !important;
        padding: 0 !important;
        left: 0 !important;
        width: 100% !important;
    }

    .page-wrapper {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }

    .content {
        margin: 0 !important;
        padding: 0 !important;
    }

    /* تنسيق الجدول للطباعة */
    .table-print {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }
    
    .table-print th,
    .table-print td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: right;
    }
    
    .table-print th {
        background-color: #f8f9fa !important;
        color: #000;
    }
    
    /* تنسيق الشعار والعنوان */
    .print-header {
        text-align: center;
        margin-bottom: 20px;
        display: block !important;
        padding: 20px;
    }
    
    .print-header h2 {
        margin: 0;
        color: #000;
        font-size: 24px;
        font-weight: bold;
    }
    
    .print-header p {
        margin: 5px 0;
        color: #666;
    }

    /* إظهار جميع الصفوف المفلترة */
    #appointments-table tr[style*="display: none"] {
        display: none !important;
    }

    #appointments-table tr:not([style*="display: none"]) {
        display: table-row !important;
    }
    
    /* تنسيق الحالة */
    .badge {
        border: 1px solid #000;
        padding: 2px 5px;
        color: #000 !important;
        background: none !important;
    }

    /* تنسيق الروابط */
    a {
        text-decoration: none !important;
        color: #000 !important;
    }

    /* إخفاء أيقونات الأزرار */
    .fas, .far, .fa {
        display: none !important;
    }
}

/* تنسيقات إضافية للشاشة */
.custom-modal .modal-content {
    border-radius: 15px;
}
</style>
{% endblock extra_js %}
