{% csrf_token %}
<div class="col-md-7 col-lg-8 col-xl-9 appointments section d-none">
    <div class="row">
        <div class="col-md-12">
            <h4 class="mb-4">الحجوزات</h4>
            <div class="appointment-tab">
                <div class="tab-content">
                    <div class="tab-pane show active" id="upcoming-appointments">
                        <div class="card card-table mb-0">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <div class="mb-3">
                                        <input type="text" id="search-input" class="form-control" placeholder="ابحث عن حجز..." onkeyup="filterAppointments()">
                                    </div>
                                    <table class="table table-hover table-center mb-0" id="appointments-table">
                                        <thead>
                                            <tr>
                                                <th>المريض</th>
                                                <th>الطبيب</th>
                                                <th>تاريخ الحجز</th>
                                                <th>حالة الحجز</th>
                                                <th>رقم الحوالة"</th>
                                                <th>الإجراءات</th>
                                                
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for booking in bookings %}
                                            <tr>
                                                <td>
                                                    <h2 class="table-avatar">
                                                        {% if booking.patient.profile_picture %}
                                                            <img src="{{ booking.patient.profile_picture.url }}" alt="Patient Image" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
                                                        {% endif %}
                                                        <a href="javascript:void(0);">{{ booking.patient.full_name }}</a>
                                                    </h2>
                                                </td>
                                                <td>
                                                    <h2 class="table-avatar">
                                                        {% if booking.doctor.profile_image %}
                                                            <img class="avatar-img rounded-circle" src="{{ booking.doctor.profile_image.url }}" alt="Doctor Image">
                                                        {% endif %}
                                                        <a href="javascript:void(0);">د. {{ booking.doctor.full_name }}</a>
                                                    </h2>
                                                </td>
                                                <td>{{ booking.booking_date }}</td>
                                                <td>
                                                    {% if booking.status == 'pending' %}
                                                        <span class="badge rounded-pill bg-warning">قيد الانتظار</span>
                                                    {% elif booking.status == 'confirmed' %}
                                                        <span class="badge rounded-pill bg-success">مؤكد</span>
                                                    {% elif booking.status == 'cancelled' %}
                                                        <span class="badge rounded-pill bg-danger">ملغي</span>
                                                    {% elif booking.status == 'completed' %}
                                                        <span class="badge rounded-pill bg-info">مكتمل</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{booking.transfer_number}}
                                                </td>
                                                <td>
                                                    <div class="table-action">

                                                    													<a href="{% url 'bookings:appointment_details' booking.id %}"  data-method="appointment_details" data-section="appointment_details" class="btn btn-sm bg-info-light">
                                                       <i class="far fa-eye"> عرض</i>
                                                    </a>
                                                        {% comment %} <a href="{% url 'bookings:appointment_details' booking.id %}" class="btn btn-sm bg-info-light">
                                                            <i class="far fa-eye"></i> 
                                                        </a> {% endcomment %}
                                                        {% if booking.status == 'pending' %}
                                                        <button type="button" class="btn badge bg-success accept-booking" data-booking-id="{{ booking.id }}"> قبول الحجز </button>
                                                        {% endif %}
                                                        {% if booking.status == 'confirmed' %}
                                                         <button type="button" class="btn badge bg-info confirmed-booking" data-booking-id-confirmed="{{ booking.id }}">تاكيد الحجز</button>
                                                        {% endif %}
                                                            
                                                        <a href="#" class="btn btn-sm bg-danger-light">
                                                            <i class="fas fa-times"></i> رفض
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center">لا توجد حجوزات حالياً</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pagination mb-3">
                <button id="prev-page" class="btn btn-secondary" onclick="changePage(-1)">الصفحة السابقة</button>
                <button id="next-page" class="btn btn-secondary" onclick="changePage(1)">الصفحة التالية</button>
            </div>
        </div>
    </div>
</div>
{% block extra_js %}
<script>
    function filterAppointments() {
        const input = document.getElementById('search-input');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('appointments-table');
        const tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) {
            const tdPatient = tr[i].getElementsByTagName('td')[0];
            const tdDoctor = tr[i].getElementsByTagName('td')[1];
            if (tdPatient || tdDoctor) {
                const txtValuePatient = tdPatient.textContent || tdPatient.innerText;
                const txtValueDoctor = tdDoctor.textContent || tdDoctor.innerText;
                if (txtValuePatient.toLowerCase().indexOf(filter) > -1 || txtValueDoctor.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
    }

    let currentPage = 1;
    const rowsPerPage = 5;

    function displayRows() {
        const table = document.getElementById('appointments-table');
        const rows = table.getElementsByTagName('tr');
        const totalRows = rows.length - 1;
        for (let i = 1; i < rows.length; i++) {
            if (i <= (currentPage * rowsPerPage) && i > ((currentPage - 1) * rowsPerPage)) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }

    function changePage(direction) {
        const table = document.getElementById('appointments-table');
        const rows = table.getElementsByTagName('tr');
        const totalRows = rows.length - 1;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        currentPage += direction;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        displayRows();
    }

    document.addEventListener('DOMContentLoaded', displayRows);

    // تهيئة Bootstrap Modal
    document.addEventListener('DOMContentLoaded', function() {
        var myModalEl = document.querySelectorAll('.modal')
        myModalEl.forEach(function(modal) {
            new bootstrap.Modal(modal);
        });
    });

    // دالة لمعالجة قبول الحجز
    document.querySelectorAll(".accept-booking").forEach(function(button) {
        button.addEventListener("click", function() {
            const bookingId = this.getAttribute("data-booking-id");
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'hospitals:accept_appointment' booking_id=0 %}".replace('0', bookingId), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'حدث خطأ أثناء قبول الحجز');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('تم قبول الحجز وتأكيد الدفع بنجاح');
                    location.reload();
                } else {
                    throw new Error(data.message || 'حدث خطأ غير معروف');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert(error.message || 'حدث خطأ أثناء قبول الحجز');
            });
        });
    });


    // دالة لمعالجة تاكيد الحجز
    document.querySelectorAll(".confirmed-booking").forEach(function(button) {
        button.addEventListener("click", function() {
            const bookingId = this.getAttribute("data-booking-id-confirmed");
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'hospitals:completed_appointment' booking_id=0 %}".replace('0', bookingId), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'حدث خطأ أثناء قبول الحجز');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('تم قبول الحجز وتأكيد الدفع بنجاح');
                    location.reload();
                } else {
                    throw new Error(data.message || 'حدث خطأ غير معروف');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert(error.message || 'حدث خطأ أثناء قبول الحجز');
            });
        });
    });

    // تعديل زر العرض لمعالجة الأخطاء
    $(document).ready(function() {
        $('.modal').on('shown.bs.modal', function () {
            $(this).find('[data-bs-toggle="tooltip"]').tooltip();
        });
    });
</script>
<style>
.custom-modal .modal-content {
    border: none;
    border-radius: 15px;
}

.custom-modal .modal-header {
    border-radius: 15px 15px 0 0;
    padding: 1rem 1.5rem;
}

.custom-modal .modal-body {
    padding: 2rem;
}

.custom-modal .card {
    border: none;
    border-radius: 10px;
    transition: transform 0.3s ease;
}

.custom-modal .card:hover {
    transform: translateY(-5px);
}

.custom-modal .info-item label {
    font-size: 0.9rem;
    font-weight: 500;
}

.custom-modal .info-item p {
    margin-bottom: 0;
}

.custom-modal .badge {
    font-size: 1rem;
    padding: 0.5rem 1rem;
}

.custom-modal .btn {
    padding: 0.5rem 1.5rem;
    border-radius: 8px;
}

.custom-modal .modal-footer {
    border-top: 1px solid #eee;
    padding: 1.5rem;
}

.rtl-alert {
    direction: rtl;
    text-align: center;
}

/* تعديل طبقة العرض للنافذة المنبثقة */
.swal2-popup {
    z-index: 9999 !important;
}

.swal2-container {
    z-index: 99999 !important;
}

/* تأكيد أن النافذة المنبثقة فوق كل العناصر */
.modal-backdrop {
    z-index: 1050 !important;
}

.modal {
    z-index: 1051 !important;
}

#appointment_details {
    z-index: 1052 !important;
}
</style>
{% endblock extra_js %}
